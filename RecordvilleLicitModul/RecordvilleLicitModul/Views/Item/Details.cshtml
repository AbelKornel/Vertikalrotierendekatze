
@model LicitModul.DnnRecordvilleLicitModul.Models.Item

@using DotNetNuke.Entities.Users
@using System.Web.Mvc
@using System.Web.Mvc.Html
@using DotNetNuke.Entities.Users
@using DotNetNuke.Web.Mvc.Helpers
@using System.Linq

@{
    var minValue = Model.HighestPrice.HasValue ? Model.HighestPrice.Value : Model.StartingPrice;
    var stepValue = Model.MinimumBidIncrement;
}


<h2>@Model.ItemName</h2>

@if (!string.IsNullOrEmpty(Model.ImageUrl))
{
    <img src="@Model.ImageUrl" alt="Kép" style="max-width: 300px;" />
}

<p><strong>Leírás:</strong> @Model.ItemDescription</p>
<p><strong>Kezdő ár:</strong> @Model.StartingPrice.ToString("N0") Ft</p>
<p><strong>Jelenlegi ár:</strong> @(Model.HighestPrice.HasValue ? Model.HighestPrice.Value.ToString("N0") + " Ft" : "Nincs még licit")</p>
<p><strong>Minimum licitlépcső:</strong> @Model.MinimumBidIncrement.ToString("N0") Ft</p>
<p><strong>Licit vége:</strong> @( (Model.AuctionEndTime.HasValue ? Model.AuctionEndTime.Value.ToLocalTime().ToString("yyyy.MM.dd HH:mm") : "Nincs beállítva") )</p>
<p><strong>Licitek száma:</strong> @(Model.RecentBids != null ? Model.RecentBids.Count() : 0)</p>

@if (Model.RecentBids != null && Model.RecentBids.Any())
{
    <h4>Legutóbbi licitek:</h4>
    <ul>
        @foreach (var bid in Model.RecentBids)
        {
            <li>@bid.Amount.ToString("N0") Ft – @bid.AuctionTime.ToLocalTime().ToString("yyyy.MM.dd HH:mm")</li>
        }
    </ul>
}
else
{
    <p>Nincs még licit.</p>
}









<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.0/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.0/dist/sweetalert2.min.js"></script>

<button id="bidButton" type="button" class="btn btn-primary" data-toggle="modal" data-target="#bidModal" data-itemid="@ViewBag.ItemId">
    Helyezd el a licitálásod
</button>

<div class="modal fade" id="bidModal" tabindex="-1" role="dialog" aria-labelledby="bidModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bidModalLabel">Licitálás</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <label for="bidAmount">Adja meg a licit összegét:</label>
                <input type="number" id="bidAmount" class="form-control" placeholder="Minimális licit összeg: 1000 Ft">
                <small id="bidError" class="text-danger" style="display: none;">A licit összegének nagyobbnak kell lennie a minimális értéknél!</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Mégse</button>
                <button type="button" id="submitBid" class="btn btn-primary">Licitálás</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function ()
    {
    var minimumBidIncrement = @ViewBag.MinimumBidIncrement;
        $('#submitBid').click(function ()
        {
        var bidAmount = $('#bidAmount').val();
        var itemId = $('#bidButton').data('itemid');
        var userId = @ViewBag.UserId;
            if (parseFloat(bidAmount) < minimumBidIncrement)
            {
                return;
            }
        $.ajax({
            type: "POST",
            url: '@Url.Action("PlaceBid", "Item")',
            data:
            {
                ItemId: itemId,
                UserId: userId,
                BidAmount: bidAmount
            },
            success: function (response)
            {
                console.log(response);
                if (response.newPrice)
                {
                    var myModal = new bootstrap.Modal(document.getElementById('bidModal'));
                    $('#currentPrice').text(response.newPrice);
                }
            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                console.log('Hiba:', textStatus, errorThrown);
            }
        });
    });
});
</script>
















